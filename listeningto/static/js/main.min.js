function setProgress(e,a,t){"soundcloud"===e&&$("#jplayer_sc").jPlayer("playHead",t.value*(100/a.soundcloud)),"youtube"===e&&yt_player_1.seekTo(a.youtube,!0)}function loadItem(e,a){stopAllPlayers(),currentPlaying.type=e,currentPlaying.songId=a,$(".song-name").text(currentPlaying.trackName),"youtube"===currentPlaying.type&&loadYoutube(a),"soundcloud"===currentPlaying.type&&loadSoundcloud(a)}function stopAllPlayers(){$("#jplayer_sc").jPlayer("stop"),yt_player_1.stopVideo(),$(".duration").html(0),$(".time").html(0),$(".pause").hide(),$(".play").show()}function onYouTubeIframeAPIReady(){yt_player_1=new YT.Player("yt_player_1",{height:"0",width:"960",events:{onStateChange:onPlayerStateChange}})}function onPlayerStateChange(e){switch(e.data){case 0:nextSong();case 1:currentPlaying.duration=convertTime(yt_player_1.getDuration()),$(".endTime").text(currentPlaying.duration),setInterval("progressBar()",100),setInterval("songTimeYT()",1e3)}}function progressBar(){"youtube"===currentPlaying.type&&$(".progress-bar").slider("value",yt_player_1.getCurrentTime()/yt_player_1.getDuration()*100)}function songTimeYT(){"youtube"===currentPlaying.type&&$(".startTime").text(convertTime(yt_player_1.getCurrentTime()))}function convertTime(e){var a="",t=parseInt(e/3600)%24,n=parseInt(e/60)%60,r=Math.round(e%60);return t>0&&10>t&&(a+=t+":"),t>=10&&(a+="0"+t+":"),a+=10>n?"0"+n+":":n+":",a+=10>r?"0"+r:r}function loadYoutube(e){yt_player_1.loadVideoById(e),$(".pause").show(),$(".play").hide()}function loadSoundcloud(e){$("#jplayer_sc").jPlayer("setMedia",{mp3:"http://api.soundcloud.com/tracks/"+e+"/stream?client_id=ad504f994ee6c4b53cfb47aec786f595"}),$("#jplayer_sc").jPlayer("play"),$("#jplayer_sc").bind($.jPlayer.event.timeupdate,function(e){currentPlaying.duration=convertTime(e.jPlayer.status.duration),$(".endTime").text(currentPlaying.duration)})}function nextSong(){var e=$("#song_"+currentPlaying.songId).next();0===e.length?$("#playlist li:first span:first a:first").trigger("click"):e.find(".song_name").trigger("click")}function saveSong(){$("#button-playlist").removeClass("active"),$("#button-recommendations").removeClass("active"),$(".error").html("");var e=document.getElementById("song_url").value;e.toLowerCase().indexOf("youtube")>=0?getSongInfo(e,"youtube",!1):e.toLowerCase().indexOf("soundcloud")>=0?getSongInfo(e,"soundcloud",!1):search(e)}function getSongInfo(e,a,t){var n=String(e),r={};if(e.toLowerCase().indexOf("youtube")>=0){var o=getURLParameter(n,"v");$.getJSON("http://gdata.youtube.com/feeds/api/videos/"+o+"?v=2&alt=jsonc",function(e){r={track_type:"youtube",track_url:n,track_name:e.data.title,track_id:o,track_artwork_url:e.data.thumbnail.hqDefault,csrfmiddlewaretoken:$('input[name="csrfmiddlewaretoken"]').val()},t?saveSongToDb(r):displayInsertedUrl(r)})}e.toLowerCase().indexOf("soundcloud")>=0&&SC.get("/resolve",{url:e},function(e){null!==e.artwork_url?(default_artwork_url=e.artwork_url,artwork_url=default_artwork_url.replace("large","t300x300")):artwork_url="https://i.ytimg.com/vi/GtBaB85VQEw/hqdefault.jpg",r={track_type:"soundcloud",track_url:e.permalink_url,track_name:e.title,track_id:e.id,stream_url:e.stream_url,track_artwork_url:artwork_url,csrfmiddlewaretoken:$('input[name="csrfmiddlewaretoken"]').val()},t?saveSongToDb(r):displayInsertedUrl(r)})}function saveSongToDb(e){$("#song_url").val("");var a=$.post("addsong/",e);a.done(function(){}),a.fail(function(){$("#song_"+e.track_id).children(".song_name").html("<p class='error-playlistmax'>Error: Your playlist is full. Please delete a song first</p>")})}function displayInsertedUrl(e){$("#playlist").empty(),"youtube"===e.track_type&&(domEl="<li id='song_"+e.track_id+"'><span class = 'song_options'><a href='#' href='#' class='play-song' title = 'Play Song' song-type='youtube' song-id='"+e.track_id+"' song-art = '"+e.track_artwork_url+"' recommendation = 'False'><i class='fa fa-play'></i></a><a href='#' class='recommend-song' title = 'Recommend Song' onClick=saveAndRecommend('youtube','https://www.youtube.com/watch?v="+e.track_id+"','"+e.track_id+"','"+encodeURIComponent(e.track_title)+"','null','"+e.track_artwork_url+"')><i class='fa fa-share'></i></a><a href='#' class='add-song' title = 'Add Song' onClick=getSongInfo('https://www.youtube.com/watch?v="+e.track_id+"','youtube','true')><i class='fa fa-plus'></i></a></span><span class='song_name' song-type='youtube' song-id='"+e.track_id+"' song-art = '"+e.track_artwork_url+"' recommendation = 'False'><p>"+e.track_name+"</p></span></li>",$("#playlist").append(domEl)),"soundcloud"===e.track_type&&(domEl="<li id='song_"+e.track_id+"'><span class = 'song_options'><a href='#' href='#' class='play-song' title = 'Play Song' song-type='soundcloud' song-id='"+e.track_id+"' song-art = '"+e.track_artwork_url+"' recommendation = 'False'><i class='fa fa-play'></i></a><a href='#' class='recommend-song' title = 'Recommend Song'  onClick=saveAndRecommend('soundcloud','"+e.track_url+"','"+e.track_id+"','"+encodeURIComponent(e.track_name)+"','"+e.track_url+"','"+e.track_artwork_url+"')><i class='fa fa-share'></i></a><a href='#' class='add-song' title = 'Add Song' onClick=getSongInfo('"+e.track_url+"','soundcloud','true')><i class='fa fa-plus'></i></a></span><span class='song_name'  song-type='soundcloud' song-id='"+e.track_id+"' song-art = '"+e.track_artwork_url+"'  recommendation = 'False'><p>"+e.track_name+"</p></span></li>",$("#playlist").append(domEl))}function recommendSong(e,a,t){$.ajax({url:"/getusers",async:!0}).done(function(e){var a=[],t=JSON.parse(e).users;_.each(_.map(t,function(e){return e}),function(e){a.push(e)}),$(".receipient_username").autocomplete({source:a,autoFocus:!0}),$(".receipient_username").autocomplete("option","appendTo","#reco-modal")}),$("html,body").css("overflow","hidden"),$("#overlay").addClass("active"),recommend.trackInfo.track_type=e,recommend.trackInfo.track_id=a,$("#recommended_song").text(decodeURIComponent(t))}function recommendTo(){recommend.receipient=$(".receipient_username").val(),recommend.description=$("#recomendation_description").val();var e={receipient_username:recommend.receipient,track_type:recommend.trackInfo.track_type,track_id:recommend.trackInfo.track_id,track_url:recommend.trackInfo.track_url,track_name:recommend.trackInfo.track_name,stream_url:recommend.trackInfo.stream_url,track_artwork_url:recommend.trackInfo.track_artwork_url,description:recommend.description,csrfmiddlewaretoken:$('input[name="csrfmiddlewaretoken"]').val()};$.post("/recommendsong/",e).done(function(){$("#overlay").removeClass("active"),$(".receipient_username").val(""),$("#recomendation_description").val(""),$("html,body").css("overflow","auto"),refreshFeed()})}function saveAndRecommend(e,a,t,n,r,o){recommend.trackInfo.track_type=e,recommend.trackInfo.track_url=a,recommend.trackInfo.track_name=unescape(n),recommend.trackInfo.track_id=t,recommend.trackInfo.stream_url=r,recommend.trackInfo.track_artwork_url=o,$.ajax({url:"/getusers",async:!0}).done(function(e){var a=[],t=JSON.parse(e).users;_.each(_.map(t,function(e){return e}),function(e){a.push(e)}),$(".receipient_username").autocomplete({source:a,autoFocus:!0}),$(".receipient_username").autocomplete("option","appendTo","#reco-modal")}),$("#overlay").addClass("active"),$("html,body").css("overflow","hidden"),$("#recommended_song").text(recommend.trackInfo.track_name)}function recommendationPage(){$.ajax({url:"/getrecommendations/",async:!0}).done(function(e){$("#playlist").html(e),$("#button-playlist").removeClass("active"),$("#button-recommendations").addClass("active")}),refreshFeed()}function getUserSongs(){$.ajax({url:"/",async:!0}).done(function(e){$("#playlist").html(e),$("#button-playlist").addClass("active"),$("#button-recommendations").removeClass("active")}),refreshFeed()}function userPlaylist(e){$.ajax({url:"/user/?user="+e,async:!0}).done(function(e){$("#playlist").html(e)}),$("#button-playlist").removeClass("active"),refreshFeed()}function deleteSong(e){$.ajax({url:"/deletesong?trackid="+e,async:!0}).done(function(){$("#song_"+e).remove()})}function loadItemAndCheckIfPlayed(e,a){loadItem(e,a);var t={track_id:a,csrfmiddlewaretoken:$('input[name="csrfmiddlewaretoken"]').val()},n=$.post("isrecoplayed/",t);n.done(function(){})}function checkIfNewRecosExist(){$.ajax({url:"/anynewrecos",async:!0}).done(function(e){"True"===e?$(".new-recommendation-indicator").css("visibility","visible"):$(".new-recommendation-indicator").css("visibility","hidden")})}function closeModal(){$("#overlay").removeClass("active"),$(".receipient_username").val(""),$("#recomendation_description").val(""),$("html,body").css("overflow","auto")}function getURLParameter(e,a){return decodeURIComponent((new RegExp("[?|&]"+a+"=([^&;]+?)(&|#|;|$)").exec(e)||[,""])[1].replace(/\+/g,"%20"))||null}function refreshFeed(){console.log("refreshing feed"),$.ajax({url:"/feed",async:!0}).done(function(e){var a=JSON.parse(e).users,t=JSON.parse(e).recommendations;a.length||t.length||$(".feedbox").hide(),$("ul.feed").html(""),_.each(_.map(a,function(e){return"<li class='feed-item'>"+e.name+" joined as <a href='#' class='user' onClick=userPlaylist('"+e.username+"')>"+e.username+"!</li>"}),function(e){$("ul.feed").append(e)}),_.each(_.map(t,function(e){return"<li class='feed-item'><a href='#' class='user' onClick=userPlaylist('"+e.sender+"')>"+e.sender+"</a> recommended <a href='#' class='play-song' title='"+e.track_name+"' song-name ='"+escape(e.track_name)+"' song-type='"+e.track_type+"' song-id='"+e.track_id+"' song-art = '"+e.track_artwork_url+"' recommendation = 'False'>"+e.track_name+"</a> to <a href='#' class='user' onClick=userPlaylist('"+e.receipient+"')>"+e.receipient+"</a></li>"}),function(e){$("ul.feed").append(e)})})}function showRegistrationForm(){$.ajax({url:"/registrationForm/",async:!0}).done(function(e){$(".auth").html(e)})}function googleApiClientReady(){gapi.client.load("youtube","v3",onYouTubeApiLoad)}function onYouTubeApiLoad(){gapi.client.setApiKey("AIzaSyDScS0XbWgnTtadhknXXwv9eqmPu9JNsno")}function search(e){$("#playlist").empty();var a="<div class = 'search-results' ><span><a href='#' class='search-results-button' id ='song-results' onClick='showSearchedSongs()'>Songs</a><a href='#' class='search-results-button' id='user-results' onClick='showSearchedUsers()'>Users</a></div>",t="<h4 class='searched-song' id='search-query'>Search Results for '"+e+"'</h4>";$("#playlist").append(a),$("#playlist").append(t),searchUsers(e),SC.get("/tracks",{q:e,limit:5},function(e){appendSC(e)});var n=gapi.client.youtube.search.list({part:"snippet",type:"video",q:e,maxResults:5});n.execute(function(e){appendYT(e)}),$("#song-results").addClass("active")}function appendSC(e){for(var a in e){var t=e[a];null!==t.artwork_url?(default_artwork_url=t.artwork_url,artwork_url=default_artwork_url.replace("large","t300x300")):artwork_url="https://i.ytimg.com/vi/GtBaB85VQEw/hqdefault.jpg",domEl="<li id='song_"+t.id+"' class='searched-song'><span class = 'song_options'><a href='#' class='play-song' title ='Play Song' song-name='"+escape(t.title)+"' song-type='soundcloud' song-id='"+t.id+"' song-art = '"+artwork_url+"' recommendation = 'False' ><i class='fa fa-play'></i></a><a href='#' id='recommend-song' title = 'Recommend Song'  onClick=saveAndRecommend('soundcloud','"+t.permalink_url+"','"+t.id+"','"+escape(t.title)+"','"+t.stream_url+"','"+artwork_url+"')><i class='fa fa-share'></i></a><a href='#' id='add-song' title = 'Add Song' onClick=getSongInfo('"+t.permalink_url+"','soundcloud','true')><i class='fa fa-plus'></i></a></span><span class='song_name' title='"+unescape(t.title)+"' song-name='"+escape(t.title)+"' song-type='soundcloud' song-id='"+t.id+"' song-art = '"+artwork_url+"' recommendation = 'False'><p>"+t.title+"</p></span></li>",$("#playlist").append(domEl)}}function appendYT(e){_.each(e.items,function(e){domEl="<li id='song_"+e.id.videoId+"' class='searched-song'><span class = 'song_options'><a href='#' class='play-song' title ='Play Song' song-name='"+escape(e.snippet.title)+"' song-type='youtube' song-id='"+e.id.videoId+"' song-art = '"+e.snippet.thumbnails.high.url+"' recommendation = 'False'><i class='fa fa-play'></i></a><a href='#' id='recommend-song' title = 'Recommend Song' onClick=saveAndRecommend('youtube','https://www.youtube.com/watch?v="+e.id.videoId+"','"+e.id.videoId+"','"+escape(e.snippet.title)+"','null','"+e.snippet.thumbnails.high.url+"')><i class='fa fa-share'></i></a><a href='#' id='add-song' title = 'Add Song' onClick=getSongInfo('https://www.youtube.com/watch?v="+e.id.videoId+"','youtube','true')><i class='fa fa-plus'></i></a></span><span class='song_name' title='"+e.snippet.title+"' song-name='"+escape(e.snippet.title)+"' song-type='youtube' song-id='"+e.id.videoId+"' song-art = '"+e.snippet.thumbnails.high.url+"' recommendation = 'False'><p>"+e.snippet.title+"</p></span></li>",$("#playlist").append(domEl)})}function searchUsers(e){$.ajax({url:"/searchusers?userquery="+e,async:!0}).done(function(a){var t=JSON.parse(a).users;if(a.length){var n="<h4 class='searched-user' id='search-query'>Users matching '"+e+"'</h4>";$("#playlist").append(n),_.each(t,function(e){var a="<li class='searched-user'><a href='#' onClick=userPlaylist('"+e.username+"')>"+e.first_name+" "+e.last_name+"</a></li>";$("#playlist").append(a)})}else{var r="<h3 class='searched-user'>No users</h3>";$("#playlist").append(r)}$(".searched-user").hide()})}function showSearchedSongs(){$("#user-results").removeClass("active"),$("#song-results").addClass("active"),$(".searched-user").hide(),$(".searched-song").show()}function showSearchedUsers(){$("#song-results").removeClass("active"),$("#user-results").addClass("active"),$(".searched-song").hide(),$(".searched-user").show()}currentPlaying={type:"",trackName:"",duration:"",songId:""};var progresspercentage=0,recommend={receipient:"",description:"",trackInfo:{track_type:"",track_url:"",track_name:"",track_id:"",stream_url:"",track_artwork_url:""}};$(document).ready(function(){var e=document.createElement("script");e.src="https://www.youtube.com/iframe_api";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(e,a),checkIfNewRecosExist(),$("#button-playlist").addClass("active"),$(".error").html("");$("#jplayer_sc").jPlayer({swfPath:"/static/jQuery.jPlayer.2.7.0/Jplayer.swf",supplied:"mp3",timeupdate:function(e){$(".progress-bar").slider("value",e.jPlayer.status.currentPercentAbsolute),$(".startTime").text(convertTime(e.jPlayer.status.currentTime))},playing:function(){$(".pause").show(),$(".play").hide()}});SC.initialize({client_id:"ad504f994ee6c4b53cfb47aec786f595"}),$(".pause").hide(),$(".play").click(function(){""===currentPlaying.trackName&&$("#playlist li:first span:first a:first").trigger("click"),"youtube"===currentPlaying.type?(yt_player_1.playVideo(),$(".pause").show(),$(".play").hide()):$("#jplayer_sc").jPlayer("play")}),$(".stop").click(function(){$(".play").show(),$(".pause").hide(),stopAllPlayers()}),$(".pause").click(function(){"youtube"===currentPlaying.type?yt_player_1.pauseVideo():$("#jplayer_sc").jPlayer("pause"),$(".pause").hide(),$(".play").show()}),$("#jplayer_sc").bind($.jPlayer.event.ended,function(){nextSong()});var t={soundcloud:"",youtube:""};$(".progress-bar").slider({animate:"fast",max:100,range:"min",step:.1,value:0,slide:function(e,a){t.youtube=a.value/100*yt_player_1.getDuration(),yt_player_1.seekTo(t.youtube,!0),$("#jplayer_sc").bind($.jPlayer.event.timeupdate,function(e){t.soundcloud=e.jPlayer.status.seekPercent}),currentPlaying.type&&(t.youtube>0||t.soundcloud>0)?setProgress(currentPlaying.type,t,a):setTimeout(function(){$(".progress").slider("value",0)},0)}}),$(document).on("click",".play-song",function(e){$(".audio-player").addClass("active"),e.stopPropagation();var a=$(this).attr("song-type"),t=$(this).attr("song-id"),n=$(this).attr("song-art"),r=$(this).attr("recommendation"),o=$(this).attr("song-name");$(".song-img").attr("src",n),currentPlaying.trackName=unescape(o),"False"===r&&loadItem(a,t),"True"===r&&loadItemAndCheckIfPlayed(a,t)}),$(document).on("click",".song_name",function(e){e.stopPropagation();var a=$(this).attr("song-type"),t=$(this).attr("song-id"),n=$(this).attr("song-art"),r=$(this).attr("recommendation"),o=$(this).attr("song-name");$(".song-img").attr("src",n),currentPlaying.trackName=unescape(o),"False"===r&&loadItem(a,t),"True"===r&&loadItemAndCheckIfPlayed(a,t)}),$(document).on("click",".recommend-song",function(e){e.stopPropagation();var a=$(this).attr("song-type"),t=$(this).attr("song-id"),n=$(this).attr("song-name");recommendSong(a,t,n)}),$(document).on("click",".delete-song",function(e){e.stopPropagation();var a=$(this).attr("song-id");deleteSong(a)}),$(document).on("click","#search",function(){saveSong()}),$(document).on("submit","#search-form",function(e){e.preventDefault()}),refreshFeed()}),$(document).ready(function(){$("#close-search").hide(),SC.initialize({client_id:"ad504f994ee6c4b53cfb47aec786f595"})});